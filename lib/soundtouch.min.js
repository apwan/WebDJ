function FifoSampleBuffer(){this._vector=new Float32Array;this._position=0;this._frameCount=0}FifoSampleBuffer.prototype={get vector(){return this._vector},get position(){return this._position},get startIndex(){return this._position*2},get frameCount(){return this._frameCount},get endIndex(){return(this._position+this._frameCount)*2},clear:function(){this.receive(frameCount);this.rewind()},put:function(t){this._frameCount+=t},putSamples:function(t,e,i){e=e||0;var r=e*2;if(!(i>=0)){i=(t.length-r)/2}var s=i*2;this.ensureCapacity(i+this._frameCount);var o=this.endIndex;this._vector.set(t.subarray(r,r+s),o);this._frameCount+=i},putBuffer:function(t,e,i){e=e||0;if(!(i>=0)){i=t.frameCount-e}this.putSamples(t.vector,t.position+e,i)},receive:function(t){if(!(t>=0)||t>this._frameCount){t=this._frameCount}this._frameCount-=t;this._position+=t},receiveSamples:function(t,e){var i=e*2;var r=this.startIndex;t.set(this._vector.subarray(r,r+i));this.receive(e)},extract:function(t,e,i){var r=this.startIndex+e*2;var s=i*2;t.set(this._vector.subarray(r,r+s))},ensureCapacity:function(t){var e=t*2;if(this._vector.length<e){var i=new Float32Array(e);i.set(this._vector.subarray(this.startIndex,this.endIndex));this._vector=i;this._position=0}else{this.rewind()}},ensureAdditionalCapacity:function(t){this.ensureCapacity(this.frameCount+t)},rewind:function(){if(this._position>0){this._vector.set(this._vector.subarray(this.startIndex,this.endIndex));this._position=0}}};function extend(t,e){for(var i in e){var r=e.__lookupGetter__(i),s=e.__lookupSetter__(i);if(r||s){if(r)t.__defineGetter__(i,r);if(s)t.__defineSetter__(i,s)}else t[i]=e[i]}return t}function testFloatEqual(t,e){return(t>e?t-e:e-t)>1e-10}function FilterSupport(t){this._pipe=t}FilterSupport.prototype={get pipe(){return this._pipe},get inputBuffer(){return this._pipe.inputBuffer},get outputBuffer(){return this._pipe.outputBuffer},fillOutputBuffer:function(t){while(this.outputBuffer.frameCount<t){var e=8192*2-this.inputBuffer.frameCount;this.fillInputBuffer(e);if(this.inputBuffer.frameCount<8192*2){break}this._pipe.process()}},clear:function(){this._pipe.clear()}};function SimpleFilter(t,e){FilterSupport.call(this,e);this.sourceSound=t;this.historyBufferSize=22050;this._sourcePosition=0;this.outputBufferPosition=0;this._position=0}extend(SimpleFilter.prototype,FilterSupport.prototype);extend(SimpleFilter.prototype,{get position(){return this._position},set position(t){if(t>this._position){throw new RangeError("New position may not be greater than current position")}var e=this.outputBufferPosition-(this._position-t);if(e<0){throw new RangeError("New position falls outside of history buffer")}this.outputBufferPosition=e;this._position=t},get sourcePosition(){return this._sourcePosition},set sourcePosition(t){this.clear();this._sourcePosition=t},fillInputBuffer:function(t){var e=new Float32Array(t*2);var i=this.sourceSound.extract(e,t,this._sourcePosition);this._sourcePosition+=i;this.inputBuffer.putSamples(e,0,i)},extract:function(t,e){this.fillOutputBuffer(this.outputBufferPosition+e);var i=Math.min(e,this.outputBuffer.frameCount-this.outputBufferPosition);this.outputBuffer.extract(t,this.outputBufferPosition,i);var r=this.outputBufferPosition+i;this.outputBufferPosition=Math.min(this.historyBufferSize,r);this.outputBuffer.receive(Math.max(r-this.historyBufferSize,0));this._position+=i;return i},handleSampleData:function(t){this.extract(t.data,4096)},clear:function(){FilterSupport.prototype.clear.call(this);this.outputBufferPosition=0}});function AbstractFifoSamplePipe(t){if(t){this.inputBuffer=new FifoSampleBuffer;this.outputBuffer=new FifoSampleBuffer}else{this.inputBuffer=this.outputBuffer=null}}AbstractFifoSamplePipe.prototype={get inputBuffer(){return this._inputBuffer},set inputBuffer(t){this._inputBuffer=t},get outputBuffer(){return this._outputBuffer},set outputBuffer(t){this._outputBuffer=t},clear:function(){this._inputBuffer.clear();this._outputBuffer.clear()}};function RateTransposer(t){AbstractFifoSamplePipe.call(this,t);this._reset();this.rate=1}extend(RateTransposer.prototype,AbstractFifoSamplePipe.prototype);extend(RateTransposer.prototype,{set rate(t){this._rate=t},_reset:function(){this.slopeCount=0;this.prevSampleL=0;this.prevSampleR=0},clone:function(){var t=new RateTransposer;t.rate=this._rate;return t},process:function(){var t=this._inputBuffer.frameCount;this._outputBuffer.ensureAdditionalCapacity(t/this._rate+1);var e=this._transpose(t);this._inputBuffer.receive();this._outputBuffer.put(e)},_transpose:function(t){if(t==0){return 0}var e=this._inputBuffer.vector;var i=this._inputBuffer.startIndex;var r=this._outputBuffer.vector;var s=this._outputBuffer.endIndex;var o=0;var n=0;while(this.slopeCount<1){r[s+2*n]=(1-this.slopeCount)*this.prevSampleL+this.slopeCount*e[i];r[s+2*n+1]=(1-this.slopeCount)*this.prevSampleR+this.slopeCount*e[i+1];n++;this.slopeCount+=this._rate}this.slopeCount-=1;if(t!=1){t:while(true){while(this.slopeCount>1){this.slopeCount-=1;o++;if(o>=t-1){break t}}var u=i+2*o;r[s+2*n]=(1-this.slopeCount)*e[u]+this.slopeCount*e[u+2];r[s+2*n+1]=(1-this.slopeCount)*e[u+1]+this.slopeCount*e[u+3];n++;this.slopeCount+=this._rate}}this.prevSampleL=e[i+2*t-2];this.prevSampleR=e[i+2*t-1];return n}});function SoundTouch(){this.rateTransposer=new RateTransposer(false);this.tdStretch=new Stretch(false);this._inputBuffer=new FifoSampleBuffer;this._intermediateBuffer=new FifoSampleBuffer;this._outputBuffer=new FifoSampleBuffer;this._rate=0;this.tempo=0;this.virtualPitch=1;this.virtualRate=1;this.virtualTempo=1;this._calculateEffectiveRateAndTempo()}extend(SoundTouch.prototype,{clear:function(){rateTransposer.clear();tdStretch.clear()},clone:function(){var t=new SoundTouch;t.rate=rate;t.tempo=tempo;return t},get rate(){return this._rate},set rate(t){this.virtualRate=t;this._calculateEffectiveRateAndTempo()},set rateChange(t){this.rate=1+.01*t},get tempo(){return this._tempo},set tempo(t){this.virtualTempo=t;this._calculateEffectiveRateAndTempo()},set tempoChange(t){this.tempo=1+.01*t},set pitch(t){this.virtualPitch=t;this._calculateEffectiveRateAndTempo()},set pitchOctaves(t){this.pitch=Math.exp(.69314718056*t);this._calculateEffectiveRateAndTempo()},set pitchSemitones(t){this.pitchOctaves=t/12},get inputBuffer(){return this._inputBuffer},get outputBuffer(){return this._outputBuffer},_calculateEffectiveRateAndTempo:function(){var t=this._tempo;var e=this._rate;this._tempo=this.virtualTempo/this.virtualPitch;this._rate=this.virtualRate*this.virtualPitch;if(testFloatEqual(this._tempo,t)){this.tdStretch.tempo=this._tempo}if(testFloatEqual(this._rate,e)){this.rateTransposer.rate=this._rate}if(this._rate>1){if(this._outputBuffer!=this.rateTransposer.outputBuffer){this.tdStretch.inputBuffer=this._inputBuffer;this.tdStretch.outputBuffer=this._intermediateBuffer;this.rateTransposer.inputBuffer=this._intermediateBuffer;this.rateTransposer.outputBuffer=this._outputBuffer}}else{if(this._outputBuffer!=this.tdStretch.outputBuffer){this.rateTransposer.inputBuffer=this._inputBuffer;this.rateTransposer.outputBuffer=this._intermediateBuffer;this.tdStretch.inputBuffer=this._intermediateBuffer;this.tdStretch.outputBuffer=this._outputBuffer}}},process:function(){if(this._rate>1){this.tdStretch.process();this.rateTransposer.process()}else{this.rateTransposer.process();this.tdStretch.process()}}});var USE_AUTO_SEQUENCE_LEN=0;var DEFAULT_SEQUENCE_MS=USE_AUTO_SEQUENCE_LEN;var USE_AUTO_SEEKWINDOW_LEN=0;var DEFAULT_SEEKWINDOW_MS=USE_AUTO_SEEKWINDOW_LEN;var DEFAULT_OVERLAP_MS=8;var _SCAN_OFFSETS=[[124,186,248,310,372,434,496,558,620,682,744,806,868,930,992,1054,1116,1178,1240,1302,1364,1426,1488,0],[-100,-75,-50,-25,25,50,75,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-20,-15,-10,-5,5,10,15,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-4,-3,-2,-1,1,2,3,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];var AUTOSEQ_TEMPO_LOW=.5;var AUTOSEQ_TEMPO_TOP=2;var AUTOSEQ_AT_MIN=125;var AUTOSEQ_AT_MAX=50;var AUTOSEQ_K=(AUTOSEQ_AT_MAX-AUTOSEQ_AT_MIN)/(AUTOSEQ_TEMPO_TOP-AUTOSEQ_TEMPO_LOW);var AUTOSEQ_C=AUTOSEQ_AT_MIN-AUTOSEQ_K*AUTOSEQ_TEMPO_LOW;var AUTOSEEK_AT_MIN=25;var AUTOSEEK_AT_MAX=15;var AUTOSEEK_K=(AUTOSEEK_AT_MAX-AUTOSEEK_AT_MIN)/(AUTOSEQ_TEMPO_TOP-AUTOSEQ_TEMPO_LOW);var AUTOSEEK_C=AUTOSEEK_AT_MIN-AUTOSEEK_K*AUTOSEQ_TEMPO_LOW;function Stretch(t){AbstractFifoSamplePipe.call(this,t);this.bQuickSeek=true;this.bMidBufferDirty=false;this.pMidBuffer=null;this.overlapLength=0;this.bAutoSeqSetting=true;this.bAutoSeekSetting=true;this._tempo=1;this.setParameters(44100,DEFAULT_SEQUENCE_MS,DEFAULT_SEEKWINDOW_MS,DEFAULT_OVERLAP_MS)}extend(Stretch.prototype,AbstractFifoSamplePipe.prototype);extend(Stretch.prototype,{clear:function(){AbstractFifoSamplePipe.prototype.clear.call(this);this._clearMidBuffer()},_clearMidBuffer:function(){if(this.bMidBufferDirty){this.bMidBufferDirty=false;this.pMidBuffer=null}},setParameters:function(t,e,i,r){if(t>0){this.sampleRate=t}if(r>0){this.overlapMs=r}if(e>0){this.sequenceMs=e;this.bAutoSeqSetting=false}else{this.bAutoSeqSetting=true}if(i>0){this.seekWindowMs=i;this.bAutoSeekSetting=false}else{this.bAutoSeekSetting=true}this.calcSeqParameters();this.calculateOverlapLength(this.overlapMs);this.tempo=this._tempo},set tempo(t){var e;this._tempo=t;this.calcSeqParameters();this.nominalSkip=this._tempo*(this.seekWindowLength-this.overlapLength);this.skipFract=0;e=Math.floor(this.nominalSkip+.5);this.sampleReq=Math.max(e+this.overlapLength,this.seekWindowLength)+this.seekLength},get inputChunkSize(){return this.sampleReq},get outputChunkSize(){return this.overlapLength+Math.max(0,this.seekWindowLength-2*this.overlapLength)},calculateOverlapLength:function(t){var e;e=this.sampleRate*t/1e3;if(e<16)e=16;e-=e%8;this.overlapLength=e;this.pRefMidBuffer=new Float32Array(this.overlapLength*2);this.pMidBuffer=new Float32Array(this.overlapLength*2)},checkLimits:function(t,e,i){return t<e?e:t>i?i:t},calcSeqParameters:function(){var t;var e;if(this.bAutoSeqSetting){t=AUTOSEQ_C+AUTOSEQ_K*this._tempo;t=this.checkLimits(t,AUTOSEQ_AT_MAX,AUTOSEQ_AT_MIN);this.sequenceMs=Math.floor(t+.5)}if(this.bAutoSeekSetting){e=AUTOSEEK_C+AUTOSEEK_K*this._tempo;e=this.checkLimits(e,AUTOSEEK_AT_MAX,AUTOSEEK_AT_MIN);this.seekWindowMs=Math.floor(e+.5)}this.seekWindowLength=Math.floor(this.sampleRate*this.sequenceMs/1e3);this.seekLength=Math.floor(this.sampleRate*this.seekWindowMs/1e3)},set quickSeek(t){this.bQuickSeek=t},clone:function(){var t=new Stretch;t.tempo=this.tempo;t.setParameters(this.sampleRate,this.sequenceMs,this.seekWindowMs,this.overlapMs);return t},seekBestOverlapPosition:function(){if(this.bQuickSeek){return this.seekBestOverlapPositionStereoQuick()}else{return this.seekBestOverlapPositionStereo()}},seekBestOverlapPositionStereo:function(){var t;var e;var i;var r;this.precalcCorrReferenceStereo();e=Number.MIN_VALUE;t=0;for(r=0;r<this.seekLength;r++){i=this.calcCrossCorrStereo(2*r,this.pRefMidBuffer);if(i>e){e=i;t=r}}return t},seekBestOverlapPositionStereoQuick:function(){var t;var e;var i;var r;var s;var o;var n;this.precalcCorrReferenceStereo();i=Number.MIN_VALUE;e=0;o=0;n=0;for(s=0;s<4;s++){t=0;while(_SCAN_OFFSETS[s][t]){n=o+_SCAN_OFFSETS[s][t];if(n>=this.seekLength)break;r=this.calcCrossCorrStereo(2*n,this.pRefMidBuffer);if(r>i){i=r;e=n}t++}o=e}return e},precalcCorrReferenceStereo:function(){var t;var e;var i;for(t=0;t<this.overlapLength;t++){i=t*(this.overlapLength-t);e=t*2;this.pRefMidBuffer[e]=this.pMidBuffer[e]*i;this.pRefMidBuffer[e+1]=this.pMidBuffer[e+1]*i}},calcCrossCorrStereo:function(t,e){var i=this._inputBuffer.vector;t+=this._inputBuffer.startIndex;var r;var s;var o;r=0;for(s=2;s<2*this.overlapLength;s+=2){o=s+t;r+=i[o]*e[s]+i[o+1]*e[s+1]}return r},overlap:function(t){this.overlapStereo(2*t)},overlapStereo:function(t){var e=this._inputBuffer.vector;t+=this._inputBuffer.startIndex;var i=this._outputBuffer.vector;var r=this._outputBuffer.endIndex;var s;var o;var n;var u;var f;var h;var a;u=1/this.overlapLength;for(s=0;s<this.overlapLength;s++){n=(this.overlapLength-s)*u;f=s*u;o=2*s;h=o+t;a=o+r;i[a+0]=e[h+0]*f+this.pMidBuffer[o+0]*n;i[a+1]=e[h+1]*f+this.pMidBuffer[o+1]*n}},process:function(){var t;var e;var i;var r;if(this.pMidBuffer==null){if(this._inputBuffer.frameCount<this.overlapLength){return}this.pMidBuffer=new Float32Array(this.overlapLength*2);this._inputBuffer.receiveSamples(this.pMidBuffer,this.overlapLength)}var s;while(this._inputBuffer.frameCount>=this.sampleReq){e=this.seekBestOverlapPosition();this._outputBuffer.ensureAdditionalCapacity(this.overlapLength);this.overlap(Math.floor(e));this._outputBuffer.put(this.overlapLength);i=this.seekWindowLength-2*this.overlapLength;if(i>0){this._outputBuffer.putBuffer(this._inputBuffer,e+this.overlapLength,i)}var o=this.inputBuffer.startIndex+2*(e+this.seekWindowLength-this.overlapLength);this.pMidBuffer.set(this._inputBuffer.vector.subarray(o,o+2*this.overlapLength));this.skipFract+=this.nominalSkip;t=Math.floor(this.skipFract);this.skipFract-=t;this._inputBuffer.receive(t)}}});extend(Stretch.prototype,{get tempo(){return this._tempo}});